<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FOTOMARATON</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f9; margin:0; padding:0; }
    .logo { width: 100%; display: block; cursor:pointer; }
    .container { max-width: 500px; margin: auto; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-top: 10px; }
    h1 { text-align: center; margin: 5px 0; }
    h2 { text-align: center; margin: 5px 0; }
    .instructions { background: #eef; padding: 10px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; }
    .rules-title { text-align: center; font-weight: bold; font-size: 18px; margin-bottom: 10px; }
    ul { list-style: none; padding: 0; }
    li { margin: 10px 0; display: flex; align-items: center; }
    input[type="checkbox"] { transform: scale(1.5); margin-right: 12px; }
    label { font-size: 16px; }
    #timerDisplay, #pauseTimerDisplay { font-size: 24px; font-weight: bold; margin: 5px; text-align:center; }
    #checklistProgress { margin-top: 10px; font-size: 16px; }
    button { padding: 8px 16px; font-size: 16px; margin: 5px; border: none; border-radius: 6px; color: white; cursor: pointer; }
    #startTimerBtn { background-color: #4CAF50; }
    #pauseBtn { background-color: #888; }
    #resetTimerBtn { background-color: #f44336; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    #pauseTimerDisplay { color: red; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body>
  <img src="NORDLO.png" alt="Logo" class="logo" id="logoBtn">

  <div class="container">
    <h1>FOTOMARATON5</h1>
    <h2>Lloret de Mar 2025</h2>

    <div class="instructions">
      <div class="rules-title">REGLER</div>
      <p>- En f√•r vara fotograf, √∂vriga ska synas p√• bilderna.</p>
      <p>- En person m√•ste alltid utf√∂ra samma sak p√• alla bilder.</p>
      <p>- Laget ska l√§mna in minst 15 bilder.</p>
      <p>- * = ALLA SKA VARA MED P√Ö BILDEN!</p>
      <p>- Laget m√•ste vara tillbaka exakt 90 minuter efter startsignalen.</p>
      <p>- H√ÖLL TIDEN!.</p>
    </div>

    <div style="text-align:center; margin-bottom: 20px;">
      <div id="timerDisplay"></div>
      <div id="warningMessage" style="display:none; text-align:center; font-size:28px; font-weight:bold; color:red; margin-top:10px;">
        ‚è∞ Mindre √§n 5 minuter kvar ‚Äì SKYNDA ER!
      </div>
      <div id="endMessage" style="display:none; text-align:center; font-size:20px; font-weight:bold; color:red; margin-top:15px;">
        üèÅ T√ÑVLINGEN √ÑR AVSLUTAD! üèÅ
      </div>
      <!-- NY SLUTTID-MEDDELANDE -->
      <div id="newEndMessage" style="display:none; text-align:center; font-size:22px; font-weight:bold; color:red; margin-top:10px;">
        ‚è±Ô∏è OBS! NY SLUTTID!
      </div>
      <div id="pauseTimerDisplay"></div>
      <div id="checklistProgress">0% slutf√∂rt</div>
      <button id="startTimerBtn">Starta t√§vlingen üèÅ</button>
      <button id="pauseBtn" disabled>Pausa 10 min üí§</button>
      <button id="resetTimerBtn">F√∂rl√§ng tiden ‚è±Ô∏è</button>
    </div>
    <ul id="checklist" style="display:none;"></ul>
  </div>

  <audio id="kazooSound" src="Kazoo.mp3" preload="metadata"></audio>
  <audio id="alarmSound" src="Alarm.mp3" preload="metadata"></audio>
  
  

  <script>
    // ---- Konfig ----
    const TOTAL_MINUTES = 17;          
    const PAUSE_MINUTES = 10;

    // ---- Element ----
    const checklist = document.getElementById('checklist');
    const checklistProgress = document.getElementById('checklistProgress');
    const timerDisplay = document.getElementById('timerDisplay');
    const pauseTimerDisplay = document.getElementById('pauseTimerDisplay');
    const startBtn = document.getElementById('startTimerBtn');
    const resetBtn = document.getElementById('resetTimerBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const logoBtn = document.getElementById('logoBtn');

    // ---- State ----
    const totalDuration = TOTAL_MINUTES * 60 * 1000;
    const pauseDuration = PAUSE_MINUTES * 60 * 1000;
    let mainTimer = null;
    let pauseTimer = null;
    let timerStarted = false;
    let pausedOnce = false;

    // Nytt f√∂r avdrag
    let adjustedOnce = false;
    let adjustmentSec = 0; 

    // ---- LocalStorage keys ----
    const LS = {
      timerStart: 'timerStart',
      totalPaused: 'totalPaused',
      pauseStart: 'pauseStart',
      pausedOnce: 'pausedOnce',
      adjustedOnce: 'adjustedOnce',
      adjustmentSec: 'adjustmentSec'
    };
    function getNum(key){ return Number(localStorage.getItem(key) || 0); }
    function setNum(key,val){ localStorage.setItem(key,String(val)); }
    function clr(key){ localStorage.removeItem(key); }

    // ---- Checklista ----
    const items = [
      '*En gruppbild i det minsta utrymmet ni f√•r plats i.', 
      '*Bygg n√•got tillsammans (Fri tolkning. G√∂r en m√§nsklig pyramid, bygg ett sandslott eller hitta en byggarbetsplats.)', 
      'En ov√§ntad v√§nskap...! üíû', 
      '*Alla i laget g√∂r samma sak (tex Alla i luften, alla p√• huk, "walk like an egyptian...")', 
      'En ‚Äúolycka‚Äù p√• semestern üò±', 
      'Tema "Havet" üåä', 
      'F√∂re & efter ‚Äì ta tv√• bilder bredvid varandra: en ‚Äúseri√∂s aff√§rsbild‚Äù och en ‚Äúsemesterbild‚Äù p√• samma plats.', 
      '*Skriv NORDLO i sanden p√• stranden och ta en gruppbild ‚ù§Ô∏è', 
      'Kl√§m ihop n√•t j√§ttestort', 
      'Akta dig f√∂r trappan! Vilken trappappappaaa...', 
      'Det minsta och st√∂rsta ni hittar som ryms i en hand', 
      '*G√∂r honn√∂r framf√∂r en font√§n! ü´°', 
      '*Asgarva! ü§£ü§£ü§£', 
      'Krama en palm! üå¥', 
      '*Flaskmata gruppledaren. üçº',
      'Vilket l√•ngt h√•r du har! JAAA',
      '*G√∂r tummen upp framf√∂r Iglesia de San Rom√°n üëç', 
      '*Turistf√§llan ‚Äì posera fint framf√∂r n√•got helt vardagligt (t.ex. en sopbil) som om det vore stadens st√∂rsta sev√§rdhet', 
      '*Alla √§r v√§nda bort fr√•n kameran', 
      '*Ta en gruppbild med en katt/hund/valfritt djur', 
      '*Peta p√• en motorcykel. En ska se glad ut, alla andra f√∂rskr√§ckta', 
      '*Ramla! (roliga gatan fram..)ü•≥', 
      '*Ha en livlig argumentation ü§åüò°', 
      'Gift er romantiskt p√• stranden üíç',
      '*N√•n i laget fyller √•r!! üéÇüéàüéâüéÅ',
      'Spela fotboll ‚öΩ',
      'Kolla! En J√ÑTTESTOR myra!üêú',
      '*Men hur gullig kan du vara egentligen?',
      '*K√∂r ett gympass! üèãÔ∏èü§∏‚Äç‚ôÇÔ∏è',
      '√Ñt n√•t litet, men gapa som att det √§r n√•t j√§ttestort', 
      'G√• vilse! üó∫Ô∏è',
      '*Spela luftgitarr och lufttrummor! üé∏',
      'Alla i laget g√∂r en ‚Äúk√§nd danspose‚Äù üíÉüï∫',
      '*√Öterskapa skivomslaget till Beatles - Abbey roadüéµ', 
      'OJ! Titta vad stark den kortaste i laget √§r!üí™',
      '*St√∂r och skapa oreda!üå™Ô∏è',
      '*√Ök rutchkana! üõù',
      '*Var spanjorer! üêÇü¶ê',
      'Ta en bild d√§r n√•gon i laget ser ut att flyga ‚úàÔ∏è',
      '*Tugga tuggummi och bl√•s en stor bubbla', 
      '*En glad sockerbagare üßë‚Äçüç≥', 
      'Fiska fisk! üêü"',
      '*N√§men! Geggamoja!',
      '*Leta upp udda hattar och ta en gruppbild üé©'
    ];
    

    items.forEach((item,index)=>{
      const li = document.createElement('li');
      const checkbox = document.createElement('input');
      checkbox.type='checkbox';
      checkbox.id=`task${index+1}`;
      if(localStorage.getItem(checkbox.id)==='true') checkbox.checked=true;
      checkbox.addEventListener('change',()=>{
        localStorage.setItem(checkbox.id,checkbox.checked);
        updateChecklistProgress();
        if(checkbox.checked && /Mobi|Android/i.test(navigator.userAgent)){
          confetti({particleCount:1000, spread:360, scalar:1.5, ticks:400,origin: { x: 0.5, y: 0.3 }});
        }
      });
      const label = document.createElement('label');
      label.htmlFor=checkbox.id;
      label.innerText=item;
      li.appendChild(checkbox);
      li.appendChild(label);
      checklist.appendChild(li);
    });

    function updateChecklistProgress(){
      const cb = checklist.querySelectorAll('input[type="checkbox"]');
      const total = cb.length;
      const checked = Array.from(cb).filter(x=>x.checked).length;
      checklistProgress.innerText = `${Math.round((checked/total)*100)}% slutf√∂rt`;
    }
    updateChecklistProgress();

    // ---- Hj√§lpfunktioner ----
    function formatTime(seconds){
      const m=Math.floor(seconds/60), s=seconds%60;
      return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }
    function preventReload(on){
      if(on){ window.addEventListener('beforeunload', blockUnload); } 
      else { window.removeEventListener('beforeunload', blockUnload); }
    }
    function blockUnload(e){ e.preventDefault(); e.returnValue=''; }
    function showChecklist(show){ checklist.style.display = show ? 'block' : 'none'; }
    function getNow(){ return Date.now(); }

    // ---- Huvudtimer ----
    function startMainTick() {
      clearInterval(mainTimer);

      mainTimer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - getNum(LS.timerStart) - getNum(LS.totalPaused)) / 1000);

        // h√§mta adjustmentSec fr√•n LS varje tick
        adjustmentSec = getNum(LS.adjustmentSec);
        adjustedOnce = localStorage.getItem(LS.adjustedOnce) === 'true';

        let remainingSec = Math.max(0, Math.ceil((totalDuration / 1000) - elapsed + adjustmentSec));

        // Efter 1 minut -> dra av 15 min
        if (elapsed >= 60 && !adjustedOnce) {
          adjustedOnce = true;
          localStorage.setItem(LS.adjustedOnce, 'true');
          adjustmentSec -= 15 * 60; 
          setNum(LS.adjustmentSec, adjustmentSec);
          document.getElementById("newEndMessage").style.display = "block";
        }

        if (remainingSec <= 0) {
          clearInterval(mainTimer);
          remainingSec = 0;
          document.getElementById("endMessage").style.display = "block";
          //try { document.getElementById("endMusic").play(); } catch(e){}

          document.getElementById("warningMessage").style.display = "none";
          document.getElementById("newEndMessage").style.display = "none";
          document.getElementById("warningMessage").style.display = (remainingSec <= 5 * 60) ? "block" : "none";
        }

        

        timerDisplay.innerText = formatTime(remainingSec);
      }, 1000);
    }

   
// ---- Start ----
function startMain(){
  if(timerStarted) return;
  timerStarted = true;

  //const endMusic = document.getElementById("endMusic");

  document.getElementById("kazooSound").play();
  
  
  startBtn.disabled = true;
  startBtn.style.backgroundColor = "#888";
  pauseBtn.disabled = false;
  pauseBtn.style.backgroundColor = "#4CAF50";
  showChecklist(true);
  preventReload(true);

  if(!localStorage.getItem(LS.timerStart)){
    setNum(LS.timerStart, getNow());
    setNum(LS.totalPaused, 0);
    clr(LS.pauseStart);
    clr(LS.adjustedOnce);
    clr(LS.adjustmentSec);
  }

  pausedOnce = localStorage.getItem(LS.pausedOnce) === 'true';
  startMainTick();
}


    // ---- Paus ----
function startPause(){
  if(!timerStarted) return;
  if(localStorage.getItem(LS.pauseStart)) return;
  if(localStorage.getItem(LS.pausedOnce) === 'true') return;
  if(!confirm("üö®‚ö†Ô∏èVARNING!‚ö†Ô∏èüö®\n\nDenna paus g√•r att anv√§nda EN g√•ng!\n\n√Ñr du HELT s√§ker p√• att du vill pausa just nu??")) return;

  localStorage.setItem(LS.pausedOnce, 'true');
  pausedOnce = true;

  pauseBtn.disabled = true;
  pauseBtn.style.backgroundColor = "#888";
  showChecklist(false);
  preventReload(true);

  const pauseStart = getNow();
  setNum(LS.pauseStart, pauseStart);

  // üëá spara pausens slut-tid ocks√•
  setNum("pauseEnd", pauseStart + pauseDuration);

  clearInterval(mainTimer);
  startPauseTick();
}



function startPauseTick(){
  clearInterval(pauseTimer);

  let remaining = Math.ceil((getNum("pauseEnd") - getNow()) / 1000);
  pauseTimerDisplay.innerText = "ü•õ V√§tskepaus " + formatTime(Math.max(0, remaining));

  pauseTimer = setInterval(()=>{
    remaining = Math.ceil((getNum("pauseEnd") - getNow()) / 1000);
    if(remaining <= 0){
      clearInterval(pauseTimer);
      pauseTimerDisplay.innerText = '';
      endPauseAndResume();
    } else {
      pauseTimerDisplay.innerText = "ü•õ V√§tskepaus " + formatTime(remaining);
    }
  }, 1000);
}
    
    function endPauseAndResume(){
      const pauseStart = getNum(LS.pauseStart);
      if(pauseStart){
        const pauseElapsed = getNow() - pauseStart;
        const totalPaused = getNum(LS.totalPaused) + pauseElapsed;
        setNum(LS.totalPaused, totalPaused);
      }
      clr(LS.pauseStart);
      showChecklist(true);
      startMainTick();
    }

    // ---- Knappar ----
    startBtn.addEventListener('click', startMain);
    pauseBtn.addEventListener('click', startPause);

    resetBtn.addEventListener('click', () => {
      document.getElementById("alarmSound").play();
      setTimeout(() => {
        alert("üö®APP-APP-APP!üö®\n\nNi har tryckt p√• en f√∂rbjuden knapp!‚ö†Ô∏è\n\nEtt meddelande om fusk har skickats till ledningsgruppen!!");
      }, 200);
    });

    logoBtn.addEventListener('click', ()=> {
      if(!confirm("Vill du sl√§ppa alla sp√§rrar och nollst√§lla?")) return;
      clearInterval(mainTimer);
      clearInterval(pauseTimer);
      clr(LS.timerStart);
      clr(LS.totalPaused);
      clr(LS.pauseStart);
      clr(LS.pausedOnce);
      clr(LS.adjustedOnce);
      clr(LS.adjustmentSec);
      timerStarted = false;
      pausedOnce = false;
      adjustedOnce = false; 
      adjustmentSec = 0;
      timerDisplay.innerText = formatTime(TOTAL_MINUTES*60);
      pauseTimerDisplay.innerText = '';
      showChecklist(false);
      preventReload(false);
      startBtn.disabled = false;
      startBtn.style.backgroundColor = "#4CAF50";
      pauseBtn.disabled = true;
      pauseBtn.style.backgroundColor = "#888";
      document.getElementById("newEndMessage").style.display = "none"; 
      checklist.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
        cb.checked = false;
        localStorage.setItem(cb.id, 'false');
      });
      updateChecklistProgress();
    });

    // ---- Init ----
  (function initFromStorage(){
      if(localStorage.getItem(LS.timerStart)){
        timerStarted=true;
        startBtn.disabled=true; startBtn.style.backgroundColor="#888";
        pauseBtn.disabled=localStorage.getItem(LS.pausedOnce)==='true';
        pauseBtn.style.backgroundColor=pauseBtn.disabled?"#888":"#4CAF50";
        const inPause=!!localStorage.getItem(LS.pauseStart);
        if(inPause){
          showChecklist(false);
          startPauseTick();
        }else{
          showChecklist(true);
          startMainTick();
        }
        preventReload(true);
      }else{
        timerDisplay.innerText=formatTime(TOTAL_MINUTES*60);
        showChecklist(false); preventReload(false);
        pauseBtn.disabled=true; pauseBtn.style.backgroundColor="#888";
      }
    })();
     
  </script>
</body>
</html>
