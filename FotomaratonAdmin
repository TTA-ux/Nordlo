<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FOTOMARATON</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f9; margin:0; padding:0; }
    .logo { width: 100%; display: block; cursor:pointer; }
    .container { max-width: 500px; margin: auto; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-top: 10px; }
    h1 { text-align: center; margin: 5px 0; }
    h2 { text-align: center; margin: 5px 0; }
    .instructions { background: #eef; padding: 10px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; }
    .rules-title { text-align: center; font-weight: bold; font-size: 18px; margin-bottom: 10px; }
    ul { list-style: none; padding: 0; }
    li { margin: 10px 0; display: flex; align-items: center; }
    input[type="checkbox"] { transform: scale(1.5); margin-right: 12px; }
    label { font-size: 16px; }
    #timerDisplay, #pauseTimerDisplay { font-size: 24px; font-weight: bold; margin: 5px; text-align:center; }
    #checklistProgress { margin-top: 10px; font-size: 16px; }
    button { padding: 8px 16px; font-size: 16px; margin: 5px; border: none; border-radius: 6px; color: white; cursor: pointer; }
    #startTimerBtn { background-color: #4CAF50; }
    #pauseBtn { background-color: #888; }
    #resetTimerBtn { background-color: #f44336; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    #pauseTimerDisplay { color: red; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body>
  <!-- Logotypen fungerar nu som "Släpp spärrar"-knapp -->
  <img src="NORDLO.png" alt="Logo" class="logo" id="logoBtn">

  <div class="container">
    <h1>FOTOMARATON</h1>
    <h2>Lloret de Mar 2025</h2>

    <div class="instructions">
      <div class="rules-title">REGLER</div>
      <p>- Alla i laget ska synas på alla bilderna.</p>
      <p>- En person måste alltid utföra samma sak på alla bilder. (Gapa/sträcka upp händerna/stå åt fel håll eller nåt annat fyndigt.)</p>
      <p>- Laget måste vara tillbaka exakt 75 minuter efter att startsignalen går.</p>
      <p>- Ett gruppfoto kommer tas vid startpunkten när tävlingstiden är ute.</p>
    </div>

    <div style="text-align:center; margin-bottom: 20px;">
      <div id="timerDisplay"></div>
      <div id="pauseTimerDisplay"></div>
      <div id="checklistProgress">0% slutfört</div>
      <button id="startTimerBtn">Starta tävlingen</button>
      <button id="pauseBtn" disabled>Pausa 10 min</button>
      <button id="resetTimerBtn">Nollställ timer</button>
    </div>

    <ul id="checklist" style="display:none;"></ul>
  </div>

  <script>
    // ---- Konfig ----
    const TOTAL_MINUTES = 6;          // Byt till 11 för test
    const PAUSE_MINUTES = 1;

    // ---- Element ----
    const checklist = document.getElementById('checklist');
    const checklistProgress = document.getElementById('checklistProgress');
    const timerDisplay = document.getElementById('timerDisplay');
    const pauseTimerDisplay = document.getElementById('pauseTimerDisplay');
    const startBtn = document.getElementById('startTimerBtn');
    const resetBtn = document.getElementById('resetTimerBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const logoBtn = document.getElementById('logoBtn');

    // ---- State ----
    const totalDuration = TOTAL_MINUTES * 60 * 1000;
    const pauseDuration = PAUSE_MINUTES * 60 * 1000;
    let mainTimer = null;
    let pauseTimer = null;
    let timerStarted = false;
    let pausedOnce = false;

    // ---- Checklista ----
    const items = [
      'En gruppbild på det minsta utrymmet ni får plats i',
      'Bygg något tillsammans (Fri tolkning. Gör en mänsklig pyramid, bygg ett sandslott eller hitta en byggarbetsplats.)',
      'En oväntad vänskap...!',
      'Alla i laget gör samma sak (tex Alla i luften, alla på huk, walk like an egyptian...)',
      'En “olycka” på semestern',
      'Havstema',
      'Före & efter – ta två bilder bredvid varandra: en “seriös affärsbild” och en “semesterbild” på samma plats.',
      'Skriv NORDLO i sanden på stranden och ta en gruppbild',
      'Kläm ihop nåt jättestort',
      'Det minsta och största ni hittar, som ryms i en hand',
      'Gör honnör framför en fontän!',
      'Krama en palm!',
      'Gör tummen upp framför Iglesia de San Román',
      'Turistfällan – posera framför något helt vardagligt (t.ex. en soptunna) som om det vore stadens största sevärdhet',
      'Alla är vända bort från kameran',
      'Ta en gruppbild med en katt/hund/valfritt djur',
      'Peta på en motorcykel. En ska se glad ut, alla andra förskräckta',
      'Ramla! (roliga gatan fram)',
      'Ha en livlig argumentation',
      'Spela fotboll',
      'Ät nåt litet, men gapa så att det är nåt jättestort',
      'Återskapa skivomslaget till Beatles - Abbey road',
      'Tugga tuggummi och blås en stor bubbla',
      'Leta upp en udda hatt och ta en bild med den'
    ];

    items.forEach((item,index)=>{
      const li = document.createElement('li');
      const checkbox = document.createElement('input');
      checkbox.type='checkbox';
      checkbox.id=`task${index+1}`;
      if(localStorage.getItem(checkbox.id)==='true') checkbox.checked=true;
      checkbox.addEventListener('change',()=>{
        localStorage.setItem(checkbox.id,checkbox.checked);
        updateChecklistProgress();
        if(checkbox.checked && /Mobi|Android/i.test(navigator.userAgent)){
          confetti({particleCount:1000, spread:360, scalar:1.5, ticks:400,origin: { x: 0.5, y: 0.3 }});
        }
      });
      const label = document.createElement('label');
      label.htmlFor=checkbox.id;
      label.innerText=item;
      li.appendChild(checkbox);
      li.appendChild(label);
      checklist.appendChild(li);
    });

    function updateChecklistProgress(){
      const cb = checklist.querySelectorAll('input[type="checkbox"]');
      const total = cb.length;
      const checked = Array.from(cb).filter(x=>x.checked).length;
      checklistProgress.innerText = `${Math.round((checked/total)*100)}% slutfört`;
    }
    updateChecklistProgress();

    // ---- Hjälpfunktioner ----
    function formatTime(seconds){
      const m=Math.floor(seconds/60), s=seconds%60;
      return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }
    function preventReload(on){
      if(on){
        window.addEventListener('beforeunload', blockUnload);
      } else {
        window.removeEventListener('beforeunload', blockUnload);
      }
    }
    function blockUnload(e){ e.preventDefault(); e.returnValue=''; }
    function showChecklist(show){ checklist.style.display = show ? 'block' : 'none'; }

    function getNow(){ return Date.now(); }

    const LS = {
      timerStart: 'timerStart',
      totalPaused: 'totalPaused',
      pauseStart: 'pauseStart',
      pausedOnce: 'pausedOnce',
      fiveMinWarned: 'fiveMinWarned',
      doneWarned: 'doneWarned'
    };

    function getNum(key){ return Number(localStorage.getItem(key) || 0); }
    function setNum(key,val){ localStorage.setItem(key,String(val)); }
    function clr(key){ localStorage.removeItem(key); }

    // ---- Huvudtimer ----
    function startMainTick(){
      clearInterval(mainTimer);
      mainTimer = setInterval(()=>{
        const timerStart = getNum(LS.timerStart);
        const totalPaused = getNum(LS.totalPaused);
        const elapsed = Math.max(0, getNow() - timerStart - totalPaused);
        let remainingSec = Math.ceil((totalDuration - elapsed)/1000);

        if(remainingSec === 300 && !localStorage.getItem(LS.fiveMinWarned)){
          localStorage.setItem(LS.fiveMinWarned,'1');
          if('vibrate' in navigator){ navigator.vibrate(10000); }
          alert('5 minuter kvar av tävlingen!');
        }

        if(remainingSec <= 0){
          remainingSec = 0;
          clearInterval(mainTimer);
          if(!localStorage.getItem(LS.doneWarned)){
            localStorage.setItem(LS.doneWarned,'1');
            if('vibrate' in navigator){ navigator.vibrate(10000); }
            alert('Tävlingen är avslutad!');
          }
          clr(LS.pauseStart);
          clr(LS.pausedOnce);
          preventReload(false);
          pauseBtn.disabled = false;
          pauseBtn.style.backgroundColor = "#4CAF50";
          timerStarted = false;
        }
        timerDisplay.innerText = formatTime(remainingSec);
      }, 1000);
    }

    function startMain(){
      if(timerStarted) return;
      timerStarted = true;

      startBtn.disabled = true;
      startBtn.style.backgroundColor = "#888";
      pauseBtn.disabled = false;
      pauseBtn.style.backgroundColor = "#4CAF50";
      showChecklist(true);
      preventReload(true);

      if(!localStorage.getItem(LS.timerStart)){
        setNum(LS.timerStart, getNow());
        setNum(LS.totalPaused, 0);
        clr(LS.pauseStart);
        clr(LS.fiveMinWarned);
        clr(LS.doneWarned);
      }

      pausedOnce = localStorage.getItem(LS.pausedOnce) === 'true';
      startMainTick();
    }

    // ---- Paus ----
    function startPause(){
      if(!timerStarted) return;
      if(localStorage.getItem(LS.pauseStart)) return;
      if(localStorage.getItem(LS.pausedOnce) === 'true') return;

      if(!confirm("OBS! Denna går att använda endast en gång!\nÄr du SÄKER på att du vill pausa?")) return;

      localStorage.setItem(LS.pausedOnce, 'true');
      pausedOnce = true;

      pauseBtn.disabled = true;
      pauseBtn.style.backgroundColor = "#888";
      showChecklist(false);
      preventReload(true);

      setNum(LS.pauseStart, getNow());
      clearInterval(mainTimer);

      clearInterval(pauseTimer);
      let remaining = Math.ceil(pauseDuration/1000);
      pauseTimerDisplay.innerText = "Paus " + formatTime(remaining);
      pauseTimer = setInterval(()=>{
        remaining--;
        if(remaining <= 0){
          clearInterval(pauseTimer);
          pauseTimerDisplay.innerText = '';
          endPauseAndResume();
        } else {
          pauseTimerDisplay.innerText = "Paus " + formatTime(remaining);
        }
      }, 1000);
    }

    function endPauseAndResume(){
      const pauseStart = getNum(LS.pauseStart);
      if(pauseStart){
        const pauseElapsed = getNow() - pauseStart;
        const totalPaused = getNum(LS.totalPaused) + pauseElapsed;
        setNum(LS.totalPaused, totalPaused);
      }
      clr(LS.pauseStart);

      showChecklist(true);
      startMainTick();
      preventReload(true);
    }

    // ---- Knappar ----
    startBtn.addEventListener('click', startMain);
    pauseBtn.addEventListener('click', startPause);

    resetBtn.addEventListener('click', () => {
      alert("APP-APP-APP!\nFörsök inte fuska!\n\nEtt meddelande har skickats till ledningen att ni tryckt på denna knapp!");
    });

    // ---- Släpp spärrar via loggan ----
    logoBtn.addEventListener('click', ()=> {
      if(!confirm("Vill du släppa alla spärrar och nollställa?")) return;

      clearInterval(mainTimer);
      clearInterval(pauseTimer);
      clr(LS.timerStart);
      clr(LS.totalPaused);
      clr(LS.pauseStart);
      clr(LS.pausedOnce);
      clr(LS.fiveMinWarned);
      clr(LS.doneWarned);

      timerStarted = false;
      pausedOnce = false;
      timerDisplay.innerText = formatTime(TOTAL_MINUTES*60);
      pauseTimerDisplay.innerText = '';
      showChecklist(false);
      preventReload(false);

      startBtn.disabled = false;
      startBtn.style.backgroundColor = "#4CAF50";
      pauseBtn.disabled = true;
      pauseBtn.style.backgroundColor = "#888";

      const checkboxes = checklist.querySelectorAll('input[type="checkbox"]');
      checkboxes.forEach(cb=>{
        cb.checked = false;
        localStorage.setItem(cb.id, 'false');
      });
      updateChecklistProgress();
    });

    // ---- Init ----
    (function initFromStorage(){
      if(localStorage.getItem(LS.timerStart)){
        timerStarted = true;
        startBtn.disabled = true;
        startBtn.style.backgroundColor = "#888";
        pauseBtn.disabled = localStorage.getItem(LS.pausedOnce)==='true';
        pauseBtn.style.backgroundColor = pauseBtn.disabled ? "#888" : "#4CAF50";

        const inPause = !!localStorage.getItem(LS.pauseStart);
        showChecklist(!inPause);
        preventReload(true);

        if(inPause){
          const elapsed = getNow() - getNum(LS.pauseStart);
          let remaining = Math.max(0, Math.ceil((pauseDuration - elapsed)/1000));
          pauseTimerDisplay.innerText = remaining>0 ? ("Paus " + formatTime(remaining)) : '';
          clearInterval(pauseTimer);
          if(remaining>0){
            pauseTimer = setInterval(()=>{
              remaining--;
              if(remaining<=0){
                clearInterval(pauseTimer);
                pauseTimerDisplay.innerText='';
                endPauseAndResume();
              }else{
                pauseTimerDisplay.innerText="Paus " + formatTime(remaining);
              }
            },1000);
          }else{
            endPauseAndResume();
          }
        }else{
          startMainTick();
        }
      }else{
        timerDisplay.innerText = formatTime(TOTAL_MINUTES*60);
        showChecklist(false);
        preventReload(false);
        pauseBtn.disabled = true;
        pauseBtn.style.backgroundColor = "#888";
      }
    })();
  </script>
</body>
</html>
